name: Commit Stage
on: [push]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: salaboy/fmtok8s-agenda-service
  VERSION: ${{ github.sha }}
  GH_PAGES_BRANCH_NAME: gh-pages

permissions:
  contents: read
  security-events: write

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      - name: Code vulnerability scanning
        uses: anchore/scan-action@v3
        id: scan
        with:
          path: "${{ github.workspace }}"
          fail-build: false
          severity-cutoff: medium
          acs-report-enable: true
      - name: Upload vulnerability report
        uses: github/codeql-action/upload-sarif@v1
        if: success() || failure()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
      - name: Build, unit tests and integration tests
        run: |
          chmod +x mvnw
          ./mvnw install
#    native:
#      name: Build and Test (Native)
#      runs-on: ubuntu-20.04
#      permissions:
#        contents: read
#      steps:
#        - name: Checkout source code
#          uses: actions/checkout@v2
#        - name: Set up GraalVM
#          uses: graalvm/setup-graalvm@v1
#          with:
#            version: '22.1.0'
#            java-version: '17'
#            components: 'native-image'
#            github-token: ${{ secrets.GITHUB_TOKEN }}
#        - name: Build, unit tests and integration tests (native)
#          run: |
#            chmod +x mvnw
#            ./mvnw spring-boot:build-image
    package:
      name: Package and Publish
      if: ${{ github.ref == 'refs/heads/main' }}
      needs: [ build ]
      runs-on: ubuntu-20.04
      permissions:
        contents: read
        packages: write
        security-events: write
      steps:
        - name: Checkout source code
          uses: actions/checkout@v2
        - name: Set up JDK
          uses: actions/setup-java@v2
          with:
            distribution: temurin
            java-version: 17
            cache: maven
        - name: Package application as JAR
          run: |
            chmod +x mvnw
            ./mvnw package
        - name: Log into container registry
          uses: docker/login-action@v1
          with:
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
        - name: Build container image
          run: |
            docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }} .
        - name: OCI image vulnerability scanning
          uses: anchore/scan-action@v3
          id: scan
          with:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
            fail-build: false
            severity-cutoff: medium
            acs-report-enable: true
        - name: Upload vulnerability report
          uses: github/codeql-action/upload-sarif@v2
          if: success() || failure()
          with:
            sarif_file: ${{ steps.scan.outputs.sarif }}
        - name: Publish container image
          run: docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        - name: Publish container image (latest)
          run: |
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }} \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
  publish_chart:
    runs-on: ubuntu-20.04
    needs: [build, package]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # Change Chart.yml [UTIL] https://github.com/fjogeleit/yaml-update-action
      # Github Action to change a local YAML file without commiting the change.
      - name: Change Chart.yml
        uses: fjogeleit/yaml-update-action@main
        # This is necessary because the property 'version' on Chart.yml must be a valid Semver 2 version.
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          valueFile: 'helm/fmtok8s-agenda-rest/Chart.yaml'
          propertyPath: 'version'
          value: '${{ github.ref_name }}'
          commitChange: false
          updateFile: true
      # Release Helm Chart [BUILD, PUBLISH] https://github.com/stefanprodan/helm-gh-pages
      # A GitHub Action for publishing Helm charts with Github Pages.
      - name: Release Helm Chart
        uses: stefanprodan/helm-gh-pages@master
        with:
          charts_dir: helm
          # It needs to be added on Github repository
          # https://github.com/salaboy/fmtok8s-agenda-rest/settings/secrets/actions
          token: ${{ secrets.PACKAGE_TOKEN }}
          repository: helm
          branch: ${{ env.GH_PAGES_BRANCH_NAME }}
          owner: ${{ env.OWNER }}